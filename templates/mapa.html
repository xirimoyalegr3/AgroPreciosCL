{% extends 'base.html' %}
{% load static %}

{% block title %}Mapa Interactivo - AgroPrecios{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/mapa.css' %}">

<!-- Mapa de Chile -->


<div class="floating-box mapa-box">
    <div class="drag-handle">⤡</div>
    <div class="box-header">
        <h3>Mapa Interactivo de Chile</h3>
    </div>
    <img id="map" src="https://commons.wikimedia.org/wiki/Special:FilePath/Mapa_de_Chile.svg" alt="Mapa de Chile">
</div>

<!-- Filtros -->
<div class="floating-box filtros-box">
    <div class="drag-handle">⤡</div>
    <div class="box-header">
        <h3>Filtros</h3>
    </div>
    <form method="GET">
        <label>Fecha:</label>
        <input type="date" name="fecha" value="{{ request.GET.fecha|default:'' }}">
        
        <label>Región:</label>
        <select name="region">
            <option value="">Todas</option>
            {% for reg in regiones %}
                <option value="{{ reg.id }}" {% if request.GET.region == reg.id|stringformat:"s" %}selected{% endif %}>{{ reg.nombre }}</option>
            {% endfor %}
        </select>
        
        <label>Mercado:</label>
        <select name="mercado">
            <option value="">Todos</option>
            {% for m in mercados %}
                <option value="{{ m.id }}" {% if request.GET.mercado == m.id|stringformat:"s" %}selected{% endif %}>{{ m.nombre }}</option>
            {% endfor %}
        </select>
        
        <label>Producto:</label>
        <select name="producto">
            <option value="">Todos</option>
            {% for p in productos %}
                <option value="{{ p.id }}" {% if request.GET.producto == p.id|stringformat:"s" %}selected{% endif %}>{{ p.nombre }}</option>
            {% endfor %}
        </select>

        <button type="submit" class="btn-filtros">Aplicar Filtros</button>
    </form>
</div>

<!-- KPIs -->
<div class="floating-box kpi-box">
    <div class="drag-handle">⤡</div>
    <div class="kpi"><h3>Mayor variación</h3>
        <p>{{ mayor_variacion.producto.nombre }} (+{{ mayor_variacion.precio_promedio }})</p>
    </div>
    <div class="kpi"><h3>Región más cara</h3>
        <p>{{ region_mas_cara.region__nombre }}</p>
    </div>
    <div class="kpi"><h3>Mercado top</h3>
        <p>{{ mercado_top.mercado__nombre }}</p>
    </div>
</div>

<!-- Tabla resultados -->
<div class="floating-box tabla-box">
    <div class="drag-handle">⤡</div>
    <h3>Resultados</h3>
    <table>
        <thead>
            <tr><th>Producto</th><th>Variedad</th><th>Calidad</th><th>Volumen</th><th>Min</th><th>Max</th><th>Promedio</th></tr>
        </thead>
        <tbody>
            {% for dato in resultados %}
            <tr>
                <td>{{ dato.producto.nombre }}</td>
                <td>{{ dato.producto.variedad_tipo }}</td>
                <td>{{ dato.producto.calidad }}</td>
                <td>{{ dato.volumen }}</td>
                <td>${{ dato.precio_minimo }}</td>
                <td>${{ dato.precio_maximo }}</td>
                <td>${{ dato.precio_promedio }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Gráfico -->
<div class="floating-box chart-box">
    <div class="drag-handle">⤡</div>
    <canvas id="chart"></canvas>
</div>

<!-- Datos de la base de datos 
<div class="floating-box datos-box">
    <div class="drag-handle">⤡</div>
    <div class="box-header">
        <h3>Datos de la Base de Datos</h3>
    </div>
    <table class="tabla-datos">
        <thead>
            <tr>
                <th>Fecha</th>
                <th>Región</th>
                <th>Mercado</th>
                <th>Producto</th>
                <th>Variedad</th>
                <th>Calidad</th>
                <th>Volumen</th>
                <th>Precio Mínimo</th>
                <th>Precio Máximo</th>
                <th>Precio Promedio</th>
            </tr>
        </thead>
        <tbody>
            {% for dato in datos_bd %}
            <tr>
                <td>{{ dato.fecha }}</td>
                <td>{{ dato.region.nombre }}</td>
                <td>{{ dato.mercado.nombre }}</td>
                <td>{{ dato.producto.nombre }}</td>
                <td>{{ dato.producto.variedad_tipo }}</td>
                <td>{{ dato.producto.calidad }}</td>
                <td>{{ dato.volumen }}</td>
                <td>${{ dato.precio_minimo }}</td>
                <td>${{ dato.precio_maximo }}</td>
                <td>${{ dato.precio_promedio }}</td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="10" class="sin-datos">No hay datos disponibles.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
-->

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="{% static 'js/mapa.js' %}"></script>
{% endblock %}
